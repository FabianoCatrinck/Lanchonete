unit Relatorio;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls,
  Data.DB, Vcl.Grids, Vcl.DBGrids, Vcl.ComCtrls,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf,
  FireDAC.Phys.Intf, FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async,
  FireDAC.Phys, FireDAC.VCLUI.Wait, FireDAC.Stan.ExprFuncs,
  FireDAC.Phys.SQLiteWrapper.Stat, FireDAC.Phys.SQLiteDef, FireDAC.Phys.SQLite,
  FireDAC.Comp.Client, FireDAC.DApt, IdHashMessageDigest,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.Comp.DataSet;

type
  TTelaRelatorio = class(TForm)
    PanelRodape: TPanel;
    BotaoFechar: TSpeedButton;
    PanelDados: TPanel;
    BotaoImprimir: TSpeedButton;
    GrupoTipoRelatório: TRadioGroup;
    EditDataInicial: TDateTimePicker;
    LabelData: TLabel;
    EditDataFinal: TDateTimePicker;
    LabelDataFinal: TLabel;
    procedure BotaoFecharClick(Sender: TObject);
    procedure BotaoImprimirClick(Sender: TObject);
  private
    { Private declarations }
    function MontarSQLPedidos(): String;
    function MontarSQLLanches(): String;
    function MontarSQLIngredientes(): String;
  public
    { Public declarations }
  end;



implementation

{$R *.dfm}

uses DataModule;

procedure TTelaRelatorio.BotaoFecharClick(Sender: TObject);
begin
  Close;
end;

procedure TTelaRelatorio.BotaoImprimirClick(Sender: TObject);
var
  Consulta: TFDQuery;
begin
  Consulta := TFDQuery.Create(nil);
  try
    Consulta.Connection := Dados.FDConnection;

    case GrupoTipoRelatorio.ItemIndex of
      0: begin
           Consulta.SQL.Add(MontarSQLPedidos());
           Consulta.ParamByName('inicio').AsDate := editdatainicial.date;
           Consulta.ParamByName('fim').AsDate := editdatafinal.date;
         end;


    end;



    Consulta.Open;

  finally
    Consulta.Close;
    FreeAndNil(Consulta);
  end;

end;

function TTelaRelatorio.MontarSQLIngredientes(): String;
var
  SQL: String;
begin
  //Ingredientes mais utilizados..
  SQL := ' select count(pi.idingrediente) as quantidade, pi.idingrediente, i.nomeingrediente '+
         ' from PedidoDetalheIngrediente pi ' +
         ' join ingrediente i on i.idingrediente = pi.idingrediente ' +
         ' group by i.idingrediente ';

  Result := SQL;
end;

function TTelaRelatorio.MontarSQLLanches(): String;
var
  SQL: String;
begin
  //Lanches mais vendidos.
  SQL := ' select count(pl.idlanche) as quantidade, pl.idlanche, l.nomelanche  '+
         ' from PedidoDetalheLanche pl ' +
         ' join lanche l on l.IdLanche = pl.idlanche ' +
         ' group by l.idlanche ';

  Result := SQL;
end;

function TTelaRelatorio.MontarSQLPedidos(): String;
var
  SQL: String;
begin
  //Total de pedidos realizados em um período
  SQL := ' select sum(valor) as total   '+
         ' from pedido ' +
         ' where data between :Inicio and :fim ';

  Result := SQL;
end;

end.
