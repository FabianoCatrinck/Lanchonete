unit ClienteCadastro;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf,
  FireDAC.Phys.Intf, FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async,
  FireDAC.Phys, FireDAC.VCLUI.Wait, FireDAC.Stan.ExprFuncs,
  FireDAC.Phys.SQLiteWrapper.Stat, FireDAC.Phys.SQLiteDef, FireDAC.Phys.SQLite,
  Data.DB, FireDAC.Comp.Client, FireDAC.DApt, IdHashMessageDigest, FireDAC.Stan.Param;

type
  TTelaClienteCadastro = class(TForm)
    PanelRodape: TPanel;
    BotaoCancelar: TSpeedButton;
    BotaoGravar: TSpeedButton;
    PanelDados: TPanel;
    LabelCodigo: TLabel;
    LabelNome: TLabel;
    EditCodigo: TEdit;
    EditNome: TEdit;
    LabelSenha: TLabel;
    LabelConfirmeSenha: TLabel;
    EditSenha: TEdit;
    EditConfirmeSenha: TEdit;
    ComboBoxTipoDeAcesso: TComboBox;
    LabelTipoDeAcesso: TLabel;
    procedure BotaoCancelarClick(Sender: TObject);
    procedure BotaoGravarClick(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure EditCodigoKeyPress(Sender: TObject; var Key: Char);
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
    FTipoOperacao, //C=Cadastro; E=Edição
    FNomeUsuario,
    FCodigo: String;
    FData: TDate;

    procedure SetData(const Value: TDate);
    function GetData(): TDate;
    procedure SetCodigo(const Value: String);
    function GetCodigo(): String;
    procedure SetNomeCliente(const Value: String);
    function GetNomeCliente(): String;
    procedure SetTipoOperacao(const Value: String);
    function GetTipoOperacao(): String;
    function ValidarCampos(): Boolean;
    function CadastrarCliente(): Boolean;
    function EditarCliente(): Boolean;
  public
    { Public declarations }
    property TipoOperacao: String read GetTipoOperacao write SetTipoOperacao;
    property NomeUsuario: String read GetNomeUsuario write SetNomeUsuario;
    property Codigo: String read GetCodigo write SetCodigo;
    property Data: TDate read GetData write SetData;
  end;


implementation

{$R *.dfm}

uses DataModule;

procedure TTelaClienteCadastro.BotaoCancelarClick(Sender: TObject);
begin
  Close;
end;

procedure TTelaClienteCadastro.BotaoGravarClick(Sender: TObject);
begin
  if ValidarCampos then
  begin
    if FTipoOperacao = 'C' then
      begin
        if CadastrarCliente then
        begin
          ShowMessage('Cliente cadastrado com sucesso!');
          Close;
        end;
      end
    else
      begin
        if EditarCliente then
        begin
          ShowMessage('Cliente editado com sucesso!');
          Close;
        end;
      end;
  end;
end;

function TTelaClienteCadastro.EditarCliente: Boolean;
var
  Usuario: TFDQuery;
begin
  Result := False;
  Usuario := TFDQuery.Create(nil);

  try
    try
      Usuario.Connection := Dados.FDConnection;

      // Inicia transação
      Dados.FDConnection.StartTransaction;

      Usuario.SQL.Add('UPDATE Usuario');
      Usuario.SQL.Add('SET NomeUsuario = :NomeUsuario, Senha = :Senha, TipoAcessoUsuario = :TipoAcessoUsuario ');
      Usuario.SQL.Add('WHERE CodigoUsuario = :CodigoUsuario');

      Usuario.ParamByName('CodigoUsuario').AsString := editCodigo.Text;
      Usuario.ParamByName('NomeUsuario').AsString := editNome.Text;
      Usuario.ParamByName('Senha').AsString := Dados.SenhaHash(editSenha.Text);
      Usuario.ParamByName('TipoAcessoUsuario').AsString := IntToStr(ComboBoxTipoDeAcesso.ItemIndex);

      Usuario.ExecSQL;

      // Finaliza transação com sucesso
      Dados.FDConnection.Commit;
      Result := True;
    except
      on E: Exception do
      begin
        // Reverte caso dê erro e libera o banco
        Dados.FDConnection.Rollback;
        ShowMessage('Erro ao gravar o usuário: ' + E.Message);
      end;
    end;
  finally
    Usuario.Free;
  end;
end;

procedure TTelaClienteCadastro.EditCodigoKeyPress(Sender: TObject;
  var Key: Char);
begin
  if not CharInSet(Key, ['0'..'9', #8, #9, #13]) then
  begin
    Key := #0;
  end;
end;

procedure TTelaClienteCadastro.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    Key := #0;
    Perform(WM_NEXTDLGCTL, 0, 0);
  end;
end;

procedure TTelaClienteCadastro.FormShow(Sender: TObject);
begin
  EditCodigo.Enabled := FTipoOperacao = 'C';

  if FTipoOperacao = 'E' then
  begin
    EditCodigo.Text := FCodigo;
    EditNome.Text := FNomeUsuario;
    ComboBoxTipoDeAcesso.ItemIndex := StrToInt(FTipoAcesso);
    EditSenha.Text := FData;
    EditConfirmeSenha.Text := FData;
  end;
end;

function TTelaClienteCadastro.GetCodigo: String;
begin
  Result := FCodigo;
end;

function TTelaClienteCadastro.GetNomeUsuario: String;
begin
  Result := FNomeUsuario;
end;

function TTelaClienteCadastro.GetSenha: String;
begin
  Result := FData;
end;

function TTelaClienteCadastro.GetTipoAcesso: String;
begin
  Result := FTipoAcesso;
end;

function TTelaClienteCadastro.GetTipoOperacao(): String;
begin
  Result := FTipoOperacao;
end;

function TTelaClienteCadastro.GetUsuarioCadastrado: Boolean;
begin
  Result := FUsuarioCadastrado;
end;

function TTelaClienteCadastro.CadastrarUsuario(): Boolean;
var
  Usuario: TFDQuery;
begin
  Result := False;
  Usuario := TFDQuery.Create(nil);

  try
    try
      Usuario.Connection := Dados.FDConnection;

      // Inicia transação
      Dados.FDConnection.StartTransaction;

      if Dados.BuscarUsuario(editCodigo.Text) then
      begin
        ShowMessage('Já existe um usuário com este código!');
        editCodigo.SetFocus;
        Dados.FDConnection.Rollback; // Libera lock
        Exit;
      end;

      Usuario.SQL.Add('INSERT INTO Usuario (IdUsuario, CodigoUsuario, NomeUsuario, Senha, TipoAcessoUsuario)');
      Usuario.SQL.Add('VALUES (:IdUsuario, :CodigoUsuario, :NomeUsuario, :Senha, :TipoAcessoUsuario)');

      Usuario.ParamByName('IdUsuario').AsInteger := Dados.GerarId('Usuario', 'IdUsuario');
      Usuario.ParamByName('CodigoUsuario').AsString := editCodigo.Text;
      Usuario.ParamByName('NomeUsuario').AsString := editNome.Text;
      Usuario.ParamByName('Senha').AsString := Dados.SenhaHash(editSenha.Text);
      Usuario.ParamByName('TipoAcessoUsuario').AsString := IntToStr(ComboBoxTipoDeAcesso.ItemIndex);

      Usuario.ExecSQL;

      // Finaliza transação com sucesso
      Dados.FDConnection.Commit;
      Result := True;

    except
      on E: Exception do
      begin
        // Reverte caso dê erro e libera o banco
        Dados.FDConnection.Rollback;
        ShowMessage('Erro ao gravar o usuário: ' + E.Message);
      end;
    end;

  finally
    Usuario.Free;
  end;
end;

procedure TTelaClienteCadastro.SetCodigo(const Value: String);
begin
  FCodigo := Value;
end;

procedure TTelaClienteCadastro.SetNomeUsuario(const Value: String);
begin
  FNomeUsuario := Value;
end;

procedure TTelaClienteCadastro.SetSenha(const Value: String);
begin
  FData := Value;
end;

procedure TTelaClienteCadastro.SetTipoAcesso(const Value: String);
begin
  FTipoAcesso := Value;
end;

procedure TTelaClienteCadastro.SetTipoOperacao(const Value: String);
begin
  FTipoOperacao := Value;
end;

procedure TTelaClienteCadastro.SetUsuarioCadastrado(const Value: Boolean);
begin
  FUsuarioCadastrado := Value;
end;

function TTelaClienteCadastro.ValidarCampos: Boolean;
begin
  Result := False;

  if Trim(editCodigo.Text) = '' then
  begin
    ShowMessage('Informe o código do usuário.');
    editCodigo.SetFocus;
    Exit;
  end;

  if Trim(editNome.Text) = '' then
  begin
    ShowMessage('Informe o nome do usuário.');
    editNome.SetFocus;
    Exit;
  end;

  if Trim(editSenha.Text) = '' then
  begin
    ShowMessage('Informe uma senha.');
    editSenha.SetFocus;
    Exit;
  end;

  if editSenha.Text <> EditConfirmeSenha.Text then
  begin
    ShowMessage('As senhas precisam ser iguais!');
    editSenha.Clear;
    EditConfirmeSenha.Clear;
    editSenha.SetFocus;
    Exit;
  end;

  if ComboBoxTipoDeAcesso.ItemIndex = -1 then
  begin
    ShowMessage('Selecione o tipo de acesso.');
    ComboBoxTipoDeAcesso.SetFocus;
    Exit;
  end;

  Result := True;
end;

end.
