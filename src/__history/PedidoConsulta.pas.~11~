unit PedidoConsulta;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls,
  Data.DB, Vcl.Grids, Vcl.DBGrids,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf,
  FireDAC.Phys.Intf, FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async,
  FireDAC.Phys, FireDAC.VCLUI.Wait, FireDAC.Stan.ExprFuncs,
  FireDAC.Phys.SQLiteWrapper.Stat, FireDAC.Phys.SQLiteDef, FireDAC.Phys.SQLite,
  FireDAC.Comp.Client, FireDAC.DApt, IdHashMessageDigest, FireDAC.Stan.Param,
  System.UITypes;

type
  TTelaPedidoConsulta = class(TForm)
    PanelRodape: TPanel;
    BotaoFechar: TSpeedButton;
    PanelDados: TPanel;
    BotaoIncluir: TSpeedButton;
    BotaoAlterar: TSpeedButton;
    BotaoExcluir: TSpeedButton;
    DBGrid: TDBGrid;
    procedure BotaoFecharClick(Sender: TObject);
    procedure BotaoIncluirClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure BotaoAlterarClick(Sender: TObject);
  private
    { Private declarations }
    procedure ApagarPedido(const IdPedido: Integer);
  public
    { Public declarations }
  end;



implementation

{$R *.dfm}

uses PedidoCadastro, DataModule;

procedure TTelaPedidoConsulta.ApagarPedido(const IdPedido: Integer);
var
  Pedido: TFDQuery;
begin
  Pedido := TFDQuery.Create(nil);

  try
    try
      Pedido.Connection := Dados.FDConnection;

      // Inicia transação
      Dados.FDConnection.StartTransaction;

      Pedido.SQL.Add('DELETE FROM Pedido ');
      Pedido.SQL.Add('WHERE IdPedido = :IdPedido');

      Pedido.ParamByName('IdPedido').AsInteger := IdPedido;

      Pedido.ExecSQL;

      //Dados.ApagarIngredientes(IdPedido, False);

      // Finaliza transação com sucesso
      Dados.FDConnection.Commit;
      ShowMessage('Pedido apagado com sucesso.');

    except
      on E: Exception do
      begin
        // Reverte caso dê erro e libera o banco
        Dados.FDConnection.Rollback;
        ShowMessage('Erro ao tentar apagar o Pedido: ' + E.Message);
      end;
    end;
  finally
    Pedido.Free;
  end;
end;

procedure TTelaPedidoConsulta.BotaoAlterarClick(Sender: TObject);
var
  TelaPedidoCadastro: TTelaPedidoCadastro;
begin
  TelaPedidoCadastro := TTelaPedidoCadastro.Create(nil);

  try
    TelaPedidoCadastro.TipoOperacao := 'E';
    TelaPedidoCadastro.IdPedido := Dados.ConsultaPedido.FieldByName('IdPedido').AsString;
    TelaPedidoCadastro.Valor := Dados.ConsultaPedido.FieldByName('Valor').AsFloat;
    TelaPedidoCadastro.Data := Dados.ConsultaPedido.FieldByName('Data').AsDate;
    TelaPedidoCadastro.IngredienteAdicional := Dados.ConsultaPedido.FieldByName('IngredienteAdicional').AsInteger;
    TelaPedidoCadastro.ShowModal;
    Dados.ConsultaPedido.Close;
    Dados.ConsultaPedido.Open;
  finally
    FreeAndNil(TelaPedidoCadastro);
  end;
end;

procedure TTelaPedidoConsulta.BotaoFecharClick(Sender: TObject);
begin
  Close;
end;

procedure TTelaPedidoConsulta.BotaoIncluirClick(Sender: TObject);
var
  TelaPedidoCadastro: TTelaPedidoCadastro;
begin
  TelaPedidoCadastro := TTelaPedidoCadastro.Create(nil);

  try
    TelaPedidoCadastro.TipoOperacao := 'C';
    TelaPedidoCadastro.ShowModal;
    Dados.ConsultaPedido.Close;
    Dados.ConsultaPedido.Open;
  finally
    FreeAndNil(TelaPedidoCadastro);
  end;
end;

procedure TTelaPedidoConsulta.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  Dados.ConsultaPedido.Close;
end;

procedure TTelaPedidoConsulta.FormCreate(Sender: TObject);
begin
  if not Dados.ConsultaPedido.Active then
    Dados.ConsultaPedido.CreateDataSet;

  DBGrid.DataSource := Dados.DataSourcePedido;
end;

end.
